name: Build e Deploy das APIs PetDex

on:
  push:
    branches:
      - main
      - dev
      - SCRUM-**

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: âš™ï¸ Definir nome da branch
        id: vars
        run: echo "BRANCH_NAME=${GITHUB_REF##*/}" >> $GITHUB_ENV

      - name: ðŸ”‘ Login no Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: ðŸ—ï¸ Build e Push da API Java
        run: |
          cd api-java
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/api-java:${BRANCH_NAME} .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/api-java:${BRANCH_NAME}

      - name: ðŸ Build e Push da API Python
        run: |
          cd api-python
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/api-python:${BRANCH_NAME} .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/api-python:${BRANCH_NAME}

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ§© Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ðŸ§¹ Remover docker-compose antigo na VM
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USER }}
          key: ${{ secrets.AZURE_VM_SSH_KEY }}
          script: |
            echo "ðŸ”¹ Removendo docker-compose antigo..."
            if [ -f "/home/${{ secrets.AZURE_VM_USER }}/petdex/docker-compose.yml" ]; then
              rm -f /home/${{ secrets.AZURE_VM_USER }}/petdex/docker-compose.yml
              echo "âœ… Arquivo removido com sucesso."
            else
              echo "â„¹ï¸ Nenhum docker-compose.yml encontrado."
            fi

      - name: ðŸ“¦ Copiar arquivos para a VM via rsync
        env:
          SSH_KEY: ${{ secrets.AZURE_VM_SSH_KEY }}
        run: |
          echo "$SSH_KEY" > key.pem
          chmod 600 key.pem

          rsync -avz -e "ssh -i key.pem -o StrictHostKeyChecking=no" \
            docker-compose.yml \
            api-java/ \
            api-python/ \
            ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }}:/home/${{ secrets.AZURE_VM_USER }}/petdex/

      - name: ðŸš€ Executar deploy via Docker Compose
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USER }}
          key: ${{ secrets.AZURE_VM_SSH_KEY }}
          script: |
            echo "ðŸš€ Atualizando APIs da PetDex na VM..."
            cd /home/${{ secrets.AZURE_VM_USER }}/petdex
            docker compose pull
            docker compose up -d --build
            echo "âœ… Deploy concluÃ­do com sucesso!"
