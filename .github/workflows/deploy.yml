name: Build e Deploy das APIs PetDex

on:
  push:
    branches:
      - main
      - dev
      - SCRUM-**

jobs:
  # ============================================================
  # JOB 1 ‚Äî BUILD E PUSH DAS IMAGENS DOCKER
  # ============================================================
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Definir nome da branch
        id: vars
        run: echo "BRANCH_NAME=${GITHUB_REF##*/}" >> $GITHUB_ENV

      - name: üîë Login no Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: üèóÔ∏è Build e Push da API Java
        run: |
          cd api-java
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/api-java:${BRANCH_NAME} .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/api-java:${BRANCH_NAME}

      - name: üêç Build e Push da API Python
        run: |
          cd api-python
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/api-python:${BRANCH_NAME} .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/api-python:${BRANCH_NAME}

  # ============================================================
  # JOB 2 ‚Äî DEPLOY NA M√ÅQUINA VIRTUAL (AP√ìS BUILD)
  # ============================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build  # s√≥ executa depois do job 'build'

    steps:
      - name: üß© Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: üßπ Remover docker-compose antigo da VM
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USER }}
          key: ${{ secrets.AZURE_VM_SSH_KEY }}
          script: |
            echo "üîπ Removendo docker-compose antigo..."
            if [ -f "/home/${{ secrets.AZURE_VM_USER }}/petdex/docker-compose.yml" ]; then
              rm -f /home/${{ secrets.AZURE_VM_USER }}/petdex/docker-compose.yml
              echo "‚úÖ Arquivo removido com sucesso."
            else
              echo "‚ÑπÔ∏è Nenhum docker-compose.yml encontrado."
            fi

      - name: üì¶ Copiar arquivos atualizados para a VM
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USER }}
          key: ${{ secrets.AZURE_VM_SSH_KEY }}
          source: |
            docker-compose.yml
            api-gateway/
            auth-service/
            pet-service/
          target: /home/${{ secrets.AZURE_VM_USER }}/petdex/
          overwrite: true

      - name: üöÄ Executar deploy via Docker Compose
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USER }}
          key: ${{ secrets.AZURE_VM_SSH_KEY }}
          script: |
            echo "üöÄ Atualizando APIs da PetDex na VM..."
            cd /home/${{ secrets.AZURE_VM_USER }}/petdex
            docker compose pull
            docker compose up -d --build
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
